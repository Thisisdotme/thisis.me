<metal:index use-macro="load: master_template.html">
	<div id="index" data-role="page" data-title="Index" data-url="/" metal:fill-slot="page_content">
    <style>
      body { background-color:#fff !important; padding:20px;}
      #index { display:none; }
      header h1 {
        margin:0;
        font-size:18px;
      }
      .author-list ul {
        list-style-type:none;
        padding:0;
        margin:8px 0 12px 0;
      }
      .author-list li {
        display:inline-block;
        vertical-align:top;
        width:90px;
        padding:8px 0;
      }
       .author-list a,  .author-list a:visited {
        color:#333;
        text-decoration:none;
        font-weight:bold;
       }
       .author-list a span {
         display:block;
        }
      .author-list a img {
        height:70px;
        width:70px;
        display:block;
        margin-bottom:4px;
        border:1px solid #ccc;
        padding:1px;
      }
      .author-list a:active img {
        border:1px solid #cee;
      }
      
      #index-content-favorites {
        display:none;
      }
      .favorites #index-content-favorites {
        display:block;
      }
      .favorites #index-content-all {
        display:none;
      }
      #tabs {
        margin-top:10px;
      }
      #tabs a {
        padding:12px 6px;
      }
      .no-favorites {
        display: inline-block;
        margin: 20px auto;
        background-color: #FAF5B1;
        opacity: 0.7;
        border: 1px solid #BAAE04;
        border-radius: 8px;
        padding: 12px;
      }
    </style>
		<header data-role="header" data-position="fixed">
			<h1>thisis.me authors</h1>
		</header><!-- /header -->
		<section id="authors">
  	  <div id="tabs"><a href="#all">All</a> | <a href="#favorites">Favorites</a></div> 
  		<div id="index-content-all" class="author-list">
  		</div><!-- /content -->
      <div id="index-content-favorites" class="author-list">
  		</div><!-- /content -->
    </section>
    <script src="/phil/asset/coreTemplates.dust.js"></script>
	</div><!-- /page -->
	
	<script type="text/javascript" metal:fill-slot="page_script">
	  window.TIM = TIM || {};
	  TIM.models = TIM.models || {};
    TIM.collections = TIM.collections || {};
    TIM.views = TIM.views || {};
    TIM.mixins = TIM.mixins || {};
    TIM.apiUrl = TIM.globals.apiBaseURL + "/v1/";
	  var authorJSON, favorites = [], renderFavorites;
	  var holding = false; var lastURL = '/', hasSession = false;
    //get the authors
    $(function(){
      hasSession = $.cookie('tim_session');
      $.cookie('tim_session', true);
      if (Modernizr.localstorage) {
        if (!hasSession) {
          lastURL = localStorage.getItem('tim_last_url');
          if(lastURL && lastURL != "/") {
             localStorage.setItem('tim_last_url', '/');
             location.href = lastURL;
             return;
          }
        } else {
          $.cookie('tim_session', true);
        }   
      
        localStorage.setItem('tim_last_url', '/');
        favorites = localStorage.getItem('tim_favorite_authors');
        
        if(favorites) {
          favorites = favorites.split(',');
        } else {
          favorites = [];
        }
        console.log('favorites: ', favorites);
      } else {
        favorites = [];
      }
    
      //prefill with people we know we have
      TIM.authors = new TIM.collections.Authors();
      TIM.authors.reset(
        [   {
              author_id: 1,
              author_name: "howard",
              email: "howard@thisis.me",
              full_name: "Howard Burrows",
              template: null
            },
            {
              author_id: 6,
              author_name: "phil",
              email: "phil@mobileidentity.me",
              full_name: "Philip Goffin",
              template: null
            },
            {
              author_id: 2,
              author_name: "loree",
              email: "loree@mobileidentity.me",
              full_name: "Loree Hirschman",
              template: null
            },
            {
              author_id: 8,
              author_name: "philblack",
              email: "pblack@trueventures.com",
              full_name: "Philip Black",
              template: null
            },
            {
              author_id: 39,
              author_name: "jose",
              email: "jose@thisis.me",
              full_name: "Jose Garcia",
              template: null
            
            },
            {
              author_id: 37,
              author_name: "Ken",
              email: "k_lenga@yahoo.com",
              full_name: "Ken Lenga",
              template: null
            },
            {
              author_id: 43,
              author_name: "mchammer",
              email: "mchammer",
              full_name: "MC Hammer",
              template: null
            }
        ]
      );
      
      function authorFetchCallback() {
        authorJSON = {"authors":
            TIM.authors.toJSON()
        }
        
        renderAuthors();
      }
      
      function renderAuthors() {
        console.log(authorJSON);
        var name;
        console.log("author json", authorJSON);
        var html = TIM.views.renderTemplate("authorList", authorJSON);
        $("#index-content-all").html(html);
        renderFavorites();
      }
      
      renderFavorites = function() {
        //now do 'favorites'
        var html = "<div class='no-favorites'>no favorites yet</div>";
        var favoritesJSON = {authors:[]};
        TIM.authors.each (function(item){
          name = item.get('author_name');
          if(isFavorite(name)) {
            favoritesJSON.authors.push(item.toJSON());
          }
        })
        console.log("favorites json", favoritesJSON);
        if(favoritesJSON.authors.length > 0) {
           html = TIM.views.renderTemplate("authorList", favoritesJSON);
        }
        $("#index-content-favorites").html(html);
      }

    	TIM.authors.fetch({
    		callbackParameter: "callback",
    		success: function(resp) {
    		  console.log('fetched authors');
    		  authorFetchCallback();
    		},
    		error: function(resp) {
    	    console.log('fetching authors failed');
    	    authorFetchCallback();
    		}
    	});
    	
    	
    	$('.author-list').on('click', 'a', function(e){
    	  if(holding) {
      	  e.preventDefault();
      	  e.stopPropagation();
      	}
    	  holding = false;
    	  console.log('click', e);
    	});
    	
    	$('#tabs a').on('tap', function(e) {
    	  e.preventDefault();
    	  e.stopPropagation();
    	  var href = $(this).attr('href');
    	  if(href === '#favorites') {
    	    $('#authors').removeClass('all').addClass('favorites');
    	  } else {
    	    $('#authors').removeClass('favorites').addClass('all');
    	  }
    	});
    	  	
    	
    	$('.author-list').on('tap', 'a', function(e) {
    	  e.preventDefault();
    	  e.stopPropagation();
    	  console.log('tap', e);
    	})
    	
    	
    	$('#index-content-all').on('hold', 'a', function(e){
    	  e.preventDefault();
    	  e.stopPropagation();
    	  console.log(e);
    	  holding = true;
    	  var a = $(e.currentTarget);
    	  var name = a.data("author_name");
    	  //search favorites, decide whether to add or delete
    	  if(isFavorite(name)) {
    	    var remove = confirm('remove ' + a.data("author_name") + ' from your favorites?');
      	  if (remove) {
            removeFavorite(name);
      	  }
    	  } else {
    	    var add = confirm('add ' + a.data("author_name") + ' as a favorite?');
      	  if (add) {
            addFavorite(name);
      	  }
    	  }
    	})
    	
    	
    	$('#index').show();
    
    });
    
    //temporary thing to make sure there are some favorites
  	function bootstrapFavorites() {
      var favs = [], name;
  	  TIM.authors.each (function(item){
  	    
  	    name = item.get('author_name');
        if (item.get('author_name') === 'mchammer' || item.get('author_name') === 'howard' ) {
          favs.push(name);
        }
      })
  	  localStorage.setItem('tim_favorite_authors', favs);
  	}
  	
  	function isFavorite (name) {
  	  for (var i = 0; i < favorites.length; i++) {
  	    if(favorites[i] === name) {
  	      return true;
  	    }
  	  }
  	  return false;
  	}
  	
  	function addFavorite(name) {
  	  if(!isFavorite(name)) {
  	    favorites.push(name);
  	  }
  	  localStorage.setItem('tim_favorite_authors', favorites);
  	  renderFavorites();
  	}
  	
  	function removeFavorite(name) {
  	  var favs = [];
  	  for (var i = 0; i < favorites.length; i++) {
  	    if(favorites[i] !== name) {
  	      favs.push(favorites[i]);
  	    }
  	  }
  	  localStorage.setItem('tim_favorite_authors', favs);
  	  favorites = favs;
  	  renderFavorites();
  	}

  </script>

</metal:index>
